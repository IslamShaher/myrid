# Shuttle Rides Feature Documentation & Test Plan

## 1. Feature Overview
The Shuttle Rides feature allows users to book rides on pre-defined routes with specific stop points. The system matches a user's desired pickup and drop-off locations to the nearest available stops on active shuttle routes.

### Key Components
- **Shuttle Routes:** Pre-defined paths containing a sequence of stops.
- **Stops:** Specific geographic locations (latitude/longitude) where passengers can be picked up or dropped off.
- **Route Matching:** Algorithm that finds the best route based on the user's start and end coordinates.
- **Booking:** Users can book a seat if the shuttle has capacity.

## 2. Implementation Details

### Database Schema
- **routes:** Stores route details (name, code, capacity, pricing).
- **stops:** Stores stop locations (name, latitude, longitude).
- **route_stops:** Pivot table linking routes and stops with an `order` field to define the sequence.
- **rides:** Stores booking information (user, route, start_stop, end_stop, status).

### API Endpoints
- `GET /api/shuttle/routes` - List all available routes.
- `GET /api/shuttle/stops` - List all available stops.
- `POST /api/shuttle/match-route` - Find a matching route based on start/end coordinates.
  - **Input:** `start_lat`, `start_lng`, `end_lat`, `end_lng`
  - **Logic:**
    1.  Finds stops within 1km radius of start and end locations.
    2.  Identifies routes containing both a start stop and an end stop.
    3.  Ensures the start stop comes *before* the end stop in the route sequence.
    4.  Calculates total walking distance and selects the best route.
- `POST /api/shuttle/create` - Book a ride on a matched route.

## 3. Test Plan

### Test Environment
- **Base URL:** `http://192.168.1.3/api` (Local) or `https://wbu.vhb.temporary.site/api` (Live)
- **Test Route:** "Dokki â†’ Sheraton Heliopolis" (Route ID: 2)
- **Stops on Route:**
  1.  Rose Hotel (30.0388148, 31.2103418) - *Start*
  2.  ...
  18. Sheraton Apartment 41 (30.1038995, 31.3710777) - *End*

### Test Scenarios

#### Scenario A: Successful Route Matching
**Objective:** Verify the system finds the correct route when user is near valid stops.
**Pre-requisites:** User is authenticated.
**Input Data:**
- **Start Location:** Near "Rose Hotel" (Lat: 30.0388000, Lng: 31.2103000)
- **End Location:** Near "Cairo Tower" (Lat: 30.0465000, Lng: 31.2242000)

**Expected Result:**
- API returns HTTP 200.
- Response contains Route ID 2.
- Suggested Start Stop: "Rose Hotel".
- Suggested End Stop: "Cairo Tower".

#### Scenario B: Reverse Direction (Invalid)
**Objective:** Verify system does not match a route if the direction is wrong (End stop is before Start stop).
**Input Data:**
- **Start Location:** Near "Cairo Tower" (Stop Order 4)
- **End Location:** Near "Rose Hotel" (Stop Order 1)

**Expected Result:**
- API returns HTTP 404 or empty list.
- Message: "No stops found" or "No matching route found".

#### Scenario C: Location Out of Range
**Objective:** Verify matching fails if user is too far (>1km) from any stop.
**Input Data:**
- **Start Location:** Maadi (Lat: 29.9600, Lng: 31.2500)
- **End Location:** Downtown (Valid)

**Expected Result:**
- API returns HTTP 404.
- Message: "No stops found near your location".

#### Scenario D: Booking a Ride
**Objective:** Verify a user can successfully book a matched route.
**Input Data:**
- **Route ID:** 2
- **Start Stop ID:** 6 (Rose Hotel)
- **End Stop ID:** 9 (Cairo Tower)
- **Passengers:** 1

**Expected Result:**
- API returns HTTP 200 / 201.
- Ride created in database with status "Active" or "Pending".
- Seat capacity updated (checked internally).

## 4. Execution Steps (Manual Testing)

1.  **Login:** Use Postman or the App to login and get a Bearer Token.
2.  **Match Route:** Send `POST /api/shuttle/match-route` with coordinates from Scenario A.
3.  **Verify Response:** Check JSON response for correct Route ID and Stop IDs.
4.  **Create Ride:** Send `POST /api/shuttle/create` with the IDs returned from step 3.
5.  **Verify DB:** Check `rides` table for the new entry.

---
*Generated by AI Assistant on 2025-11-29*


